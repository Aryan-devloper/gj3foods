{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register - Foodeat</title>

  <!-- Font Awesome + Custom CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/css2.css' %}">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    .auth-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 40px 15px;
    }
    .auth-content {
      background: #fff;
      width: 100%;
      max-width: 560px;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    /* ---------- Steps Indicator ---------- */
    .steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 25px;
      padding: 0;
      list-style: none;
      position: relative;
    }
    .steps li {
      flex: 1;
      text-align: center;
      font-weight: 600;
      color: #999;
      position: relative;
      z-index: 1;
      transition: 0.3s;
    }
    .steps li i {
      display: block;
      font-size: 1.2rem;
      margin-bottom: 5px;
    }
    .steps li::before {
      content: attr(data-step);
      display: inline-block;
      width: 32px;
      height: 32px;
      line-height: 32px;
      border-radius: 50%;
      background: #ccc;
      color: #fff;
      margin-bottom: 8px;
      font-size: 0.9rem;
      position: relative;
      z-index: 2;
      transition: 0.3s;
    }
    .steps li::after {
      content: '';
      position: absolute;
      top: 16px;
      left: 50%;
      width: 100%;
      height: 3px;
      background: #ccc;
      z-index: -1;
      transition: 0.3s;
    }
    .steps li:last-child::after { display: none; }
    .steps li.active,
    .steps li.completed { color: #111; }
    .steps li.active::before,
    .steps li.completed::before { background: #f8b602; }
    .steps li.completed::after { background: #f8b602; }

    /* ---------- Form & Input ---------- */
    .form-field { margin-bottom: 15px; position: relative; }
    .form-field label { font-weight: 600; font-size: 0.9rem; margin-bottom: 6px; display: block; }
    .form-field .input-icon {
      position: absolute;
      top: 38px;
      left: 12px;
      color: #777;
      font-size: 1rem;
    }
    .form-field input, 
    .form-field select {
      width: 100%;
      padding: 12px 12px 12px 38px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
    }
    .error-msg {
      color: red;
      font-size: 0.85rem;
      margin-top: 3px;
      display: none;
    }

    .submit-btn {
      width: 100%;
      padding: 12px;
      border: none;
      background: #f8b602;
      color: #111;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
      transition: 0.3s;
    }
    .submit-btn:hover { background: #f89302; }

    .step { display: none; }
    .step.active { display: block; }

    .file-upload-wrapper {
      border: 2px dashed #ccc;
      border-radius: 8px;
      text-align: center;
      padding: 15px;
      cursor: pointer;
      position: relative;
    }
    .file-upload-wrapper input[type="file"] {
      position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    @media(max-width:600px){
      .form-grid { grid-template-columns: 1fr; }
    }
    .preview { margin-top: 10px; text-align: center; }
    .preview img {
      width: 90px; height: 90px;
      border-radius: 50%; object-fit: cover;
      border: 2px solid #f8b602;
    }
  </style>
</head>
<body>
  {% include 'header.html' %}

  <main class="auth-container">
    <div class="auth-content">

      <!-- Step Indicator -->
      <ul class="steps">
        <li id="indicator1" data-step="1" class="active"><i class="fas fa-user"></i>Basic Info</li>
        <li id="indicator2" data-step="2"><i class="fas fa-lock"></i>Security</li>
        <li id="indicator3" data-step="3"><i class="fas fa-envelope"></i>Verify</li>
      </ul>

      <form id="registerForm" method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        <!-- STEP 1: BASIC INFO -->
        <div id="step1" class="step active">
          <div class="form-grid">
            <div class="form-field">
              <label>First Name</label>
              <i class="fas fa-user input-icon"></i>
              {{ form.first_name }}
              <div class="error-msg">First name is required</div>
            </div>
            <div class="form-field">
              <label>Last Name</label>
              <i class="fas fa-user input-icon"></i>
              {{ form.last_name }}
              <div class="error-msg">Last name is required</div>
            </div>
            <div class="form-field">
              <label>Email</label>
              <i class="fas fa-envelope input-icon"></i>
              {{ form.email }}
              <div class="error-msg">Valid email is required</div>
            </div>
            <div class="form-field">
              <label>Phone</label>
              <i class="fas fa-phone input-icon"></i>
              {{ form.phone }}
              <div class="error-msg">Phone number is required</div>
            </div>
            <div class="form-field">
              <label>Gender</label>
              <i class="fas fa-venus-mars input-icon"></i>
              {{ form.gender }}
              <div class="error-msg">Please select gender</div>
            </div>
            <div class="form-field">
              <label>City</label>
              <i class="fas fa-city input-icon"></i>
              {{ form.city }}
              <div class="error-msg">City is required</div>
            </div>
          </div>
          <button type="button" class="submit-btn" onclick="validateStep1()">Next</button>
        </div>

        <!-- STEP 2: SECURITY -->
        <div id="step2" class="step">
          <div class="form-grid">
            <div class="form-field">
              <label>Password</label>
              <i class="fas fa-lock input-icon"></i>
              {{ form.password }}
              <div class="error-msg">Password is required</div>
            </div>
            <div class="form-field">
              <label>Confirm Password</label>
              <i class="fas fa-key input-icon"></i>
              {{ form.confirm_password }}
              <div class="error-msg">Confirm password is required</div>
            </div>
          </div>
          <div class="form-field">
            <label>Profile Image</label>
            <label class="file-upload-wrapper">
              {{ form.profile_image }}
              <div class="file-upload-prompt">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Click to upload profile image</p>
              </div>
            </label>
            <div id="imagePreview" class="preview"></div>
          </div>
          <button type="button" class="submit-btn" onclick="prevStep(1)">Back</button>
          <button type="button" class="submit-btn" onclick="sendOtp()">Send OTP</button>
        </div>

        <!-- STEP 3: VERIFY -->
        <div id="step3" class="step">
          <p><i class="fas fa-envelope-open-text"></i> An OTP has been sent to your email. Enter it below:</p>
          <div class="form-field">
            <label for="otp">Enter OTP</label>
            <i class="fas fa-shield-alt input-icon"></i>
            <input type="text" name="otp" maxlength="6" required placeholder="------">
          </div>
          <button type="button" class="submit-btn" onclick="prevStep(2)">Back</button>
          <button type="submit" name="create_user" class="submit-btn">Verify & Create Account</button>
        </div>
      </form>
    </div>
  </main>

  <script>
    function updateIndicator(step){
      let indicators = document.querySelectorAll(".steps li");
      indicators.forEach((s, index) => {
        s.classList.remove("active", "completed");
        if(index + 1 < step){ s.classList.add("completed"); }
        if(index + 1 === step){ s.classList.add("active"); }
      });
    }

    function nextStep(step){
      document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
      document.getElementById("step"+step).classList.add("active");
      updateIndicator(step);
    }
    function prevStep(step){
      document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
      document.getElementById("step"+step).classList.add("active");
      updateIndicator(step);
    }

    function validateStep1(){
      let valid = true;
      let step1 = document.getElementById("step1");
      let inputs = step1.querySelectorAll("input, select");
      inputs.forEach(input => {
        let errorMsg = input.parentElement.querySelector(".error-msg");
        if(errorMsg){
          if(input.value.trim() === "" || (input.type === "email" && !validateEmail(input.value))){
            errorMsg.style.display = "block"; valid = false;
          } else { errorMsg.style.display = "none"; }
        }
      });
      if(valid){ nextStep(2); }
    }

    function validateStep2(){
      let valid = true;
      let step2 = document.getElementById("step2");
      let password = step2.querySelector("input[name='password']");
      let confirm = step2.querySelector("input[name='confirm_password']");
      let image = step2.querySelector("input[type='file']");

      if(password.value.trim() === ""){
        password.parentElement.querySelector(".error-msg").style.display = "block";
        valid = false;
      } else { password.parentElement.querySelector(".error-msg").style.display = "none"; }

      if(confirm.value.trim() === "" || confirm.value !== password.value){
        confirm.parentElement.querySelector(".error-msg").innerText = "Passwords must match";
        confirm.parentElement.querySelector(".error-msg").style.display = "block";
        valid = false;
      } else { confirm.parentElement.querySelector(".error-msg").style.display = "none"; }

      if(image.files.length === 0){ alert("Please upload an image."); valid = false; }
      return valid;
    }

    function sendOtp(){
      if (!validateStep2()) return;
      let formData = new FormData(document.getElementById("registerForm"));
      fetch("{% url 'send_otp' %}", {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
      })
      .then(res => res.json())
      .then(data => {
        if(data.success){
          alert("OTP sent to your email!");
          nextStep(3);
        } else { alert(data.message); }
      })
      .catch(err => {
        console.error(err);
        alert("Error sending OTP");
      });
    }

    function validateEmail(email){
      let re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    document.addEventListener("change", function(e){
      if(e.target && e.target.type === "file"){
        let file = e.target.files[0];
        if(file){
          let reader = new FileReader();
          reader.onload = function(ev){
            document.getElementById("imagePreview").innerHTML =
              "<img src='"+ev.target.result+"' alt='Preview'>";
          }
          reader.readAsDataURL(file);
        }
      }
    });
  </script>
</body>
</html>
